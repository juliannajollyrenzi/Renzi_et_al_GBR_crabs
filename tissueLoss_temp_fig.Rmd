---
title: "Tissue loss vs. temperature plot"
author: "Julianna Renzi"
date: "11/7/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

require(tidyverse) # data manipulation
require(here) # relative file paths
require(lubridate) # dates and times
require(wesanderson) # color palette
require(patchwork) # combining figures
```

# Bring in the data

```{r}
# this is the temperature time series from the experiment, with one value per date/time (averaged across HOBO loggers, with a value per few minutes)
tempTimeseries <- read_csv(here("generated_data/hobo_timeseries.csv"))

# this is the daily previous mean maximum water temperatures with a 4-day window
avgMax4 <- read_csv(here("generated_data/temperature_metrics.csv"))

# this is the percent tissue loss on a nubbin on a given day (cumulative, taken from photos)
nubbinDat <- read_csv(here("data/Nubbin_percent_cover.csv"))
  nubbinDat$Date <- as.Date(nubbinDat$Date, format='%m/%d/%y') # get dates in datetime format
  
# this is the metadata for the experiment
metadat <- read.csv(here("data/Coral_metadata.csv")) 
```

Create our color palette from the Wes Anderson package

```{r}
vibRed <- wes_palette("Darjeeling1", n = 5)[1]
forGreen <- wes_palette("Darjeeling1", n = 5)[2]
lightO <- wes_palette("Darjeeling1", n = 5)[3]
darkO <- wes_palette("Darjeeling1", n = 5)[4]
skyB <- wes_palette("Darjeeling1", n = 5)[5]

```


# Plot temperature through time

Look at how the temperature changes over time

```{r}
tempTimeseries %>% 
  filter(Date_time > as_datetime("2020-02-03 00:00:00")) %>% # just from the start of the tissue loss data
  ggplot(aes(x = Date_time, y = Mean_temp)) +
  geom_line() +
  # plot the maximum/4 day  moving window as well
  #geom_line(aes(x = as_datetime(Date), y = Mean_max_C_4), data = subset(avgMax4, Date > as_datetime("2020-02-03")), 
  #          color = vibRed) +
  geom_hline(yintercept = 27.3, 
             color = vibRed, 
             linetype = "dashed") + # this is the Heron monthly mean water temp according to: https://seatemperature.info/heron-island-water-temperature.html and also word of mouth from Jesse + Gus
  theme_classic() +
  # make first rectangle highlighting the first peak 
  annotate("rect",
           xmin = as_datetime("2020-02-03 00:00:00"), 
           xmax = as_datetime("2020-02-08 00:00:00"), 
           ymin = -Inf, 
           ymax = Inf, fill = lightO, alpha = 0.2) +
  annotate("rect",
           xmin = as_datetime("2020-02-15 00:00:00"), 
           xmax = as_datetime("2020-02-22 00:00:00"), 
           ymin = -Inf, 
           ymax = Inf, fill = lightO, alpha = 0.2) +
  ylab("Water temperature (°C)") +
  xlab("Date") +
  ylim(26, 33) -> tempTSFig
  

```

And how the maximum changes through time

```{r}
avgMax4 %>% 
  filter(Date > as.Date("2020-02-03", "%Y-%m-%d")) %>%  # just from the start of the tissue loss data
  ggplot(aes(x = Date, y = Mean_max_C_4)) +
  geom_line() +
  geom_hline(yintercept = 27.3, 
             color = vibRed, 
             linetype = "dashed") + # this is the Heron monthly mean water temp according to: https://seatemperature.info/heron-island-water-temperature.html and also word of mouth from Jesse + Gus
  theme_classic() +
  # make first rectangle highlighting the first peak 
  annotate("rect",
           xmin = as.Date("2020-02-03", "%Y-%m-%d"), 
           xmax = as.Date("2020-02-08", "%Y-%m-%d"), 
           ymin = -Inf, 
           ymax = Inf, fill = lightO, alpha = 0.2) +
  annotate("rect",
           xmin = as.Date("2020-02-15", "%Y-%m-%d"), 
           xmax = as.Date("2020-02-22", "%Y-%m-%d"), 
           ymin = -Inf, 
           ymax = Inf, fill = lightO, alpha = 0.2) +
  ylab("Mean maximum temperature-4 day (°C)") +
  xlab("Date") +
  # make y limits match mean temperature figure
  ylim(26, 33) -> maxTSFig
```


# Plot tissue loss through time

Start by getting daily tissue loss

```{r}
# summarize for each date (average both coral sides)
nubbinDat %>% 
  group_by(Coral_ID, Date) %>% # average for both sides (front & back)
  summarize(Percent_white_both_sides = mean(Percent_dead)) %>% 
  full_join(metadat, key = Coral_ID) %>% # add in metadata
  drop_na(Coral_ID) -> treatPercChange

# get daily change for each coral
treatPercChange %>% 
  # first get the change in percent cover since the last day
  mutate(Perc_tissue_loss = (Percent_white_both_sides - lag(Percent_white_both_sides))) %>% 
  # Negatives are zero (i.e. going to a new coral record)
  mutate(Perc_tissue_loss = replace(Perc_tissue_loss, which(Perc_tissue_loss < 0), 0)) %>% 
  mutate(Perc_tissue_loss = replace_na(Perc_tissue_loss, 0)) -> tissueLoss
```

Then get the average tissue loss by treatment (average tissue loss across the treatment group on a given day)

```{r}
tissueLoss %>% 
  group_by(Crab_treatment, Algae_treatment, Wounding_treatment, Date) %>% 
  summarize(MeanTL = mean(Perc_tissue_loss)) -> avgTL
```


Then plot the data through time, broken up by treatments

```{r}
# make labels nice
crab.labs <- c("Crab", "No crab")
names(crab.labs) <- c("Y", "N")


avgTL %>%
  # only want values after Feb 4 (4 is tissue loss over multiple days d)
  filter(Date > as_datetime("2020-02-04 00:00:00")) %>% 
  ggplot(aes(x = Date, y = MeanTL, color = Algae_treatment, linetype = Wounding_treatment)) +
  geom_line() +
  scale_linetype_manual(values=c("solid", "dashed"),
                        name = "Wounding") +
  facet_grid(.~Crab_treatment, labeller = labeller(Crab_treatment = crab.labs)) + # facet by crabs
  ylab("Average tissue loss (%)") +
  xlab("Date") +
  scale_color_manual(values = c(darkO, skyB),
                     name = "Algae") + # clean up legend and colors
  theme_classic() +
  # add rectangles showing extreme heat periods
  annotate("rect",
           xmin = as.Date("2020-02-03", "%Y-%m-%d"), 
           xmax = as.Date("2020-02-08", "%Y-%m-%d"), 
           ymin = -Inf, 
           ymax = Inf, fill = yell, alpha = 0.2) +
  annotate("rect",
           xmin = as.Date("2020-02-15 00:00:00", "%Y-%m-%d"), 
           xmax = as.Date("2020-02-22 00:00:00", "%Y-%m-%d"), 
           ymin = -Inf, 
           ymax = Inf, fill = yell, alpha = 0.2) -> tissueLFig
```

# Combine figures 

To save these figures as a PDF in the figures folder, remove the pound signs before the `pdf()` and `dev.off()`

```{r}
# pdf(file = here("figures/tissueLTempseries.pdf"), width = 9.5, height = 6.5)

(tempTSFig + maxTSFig) / (tissueLFig)

# dev.off()
```

